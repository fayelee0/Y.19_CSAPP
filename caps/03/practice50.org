#+AUTHOR: Fei Li
#+EMAIL: wizard@pursuetao.com
* Practice 50

  #+BEGIN_SRC c

  double fcvt2(int* ip, float* fp, double* dp, long l)
  {
      int   i  = *ip;
      float f  = *fp;
      double d = *dp;

      *ip = (int) val1;
      *fp = (float) val2;
      *dp = (double) val3;
      
      return (double) val4;
  }

  
  #+END_SRC

  
  #+BEGIN_SRC asm

  ; double fcvt2(int* ip, float* fp, double* dp, long l)
  ; ip in %rdi, fp in %rsi, dp in %rdx, l in %rcx
  ; result returned in %xmm0
  fcvt2:
    movl        (%rdi), %eax              ; i => %eax
    vmovss      (%rsi), %xmm0             ; f => %xmm0
    vcvttsd2si  (%rdx), %r8d              ; d -> int => %r8d
    movl        %r8d, (%rdi)              ; %r8d => ip
    vcvtsi2ss   %eax, %xmm1, %xmm1        ; i -> float => %xmm1
    vmovss      %xmm1, (%rsi)             ; %xmm1 => fp
    vcvtsi2sdq  %rcx, %xmm1, %xmm1        ; l -> double => %xmm1
    vmovsd      %xmm1, (%rdx)             ; %xmm1 => dp
    vunpcklps   %xmm0, %xmm0, %xmm0       
    vcvtps2pd   %xmm0, %xmm0              ; (double) f;
    ret
  
  #+END_SRC


  #+BEGIN_SRC c

  double fcvt2(int* ip, float* fp, double* dp, long l
  {
      int i = *ip;
      flaot f = *fp;
      double d = *dp;

      *ip = (int) d;
      *fp = (float) i;
      *dp = (double) l;

      return (double) f;
  }
  
  #+END_SRC
